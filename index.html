<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IQãƒ€ã‚¤ã‚¨ãƒƒãƒˆ - å°‚é–€ã‚³ãƒ³ã‚µãƒ«ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <!-- Facebook Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
    n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}
    (window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

    fbq('init','1494090128389962');   // IQ Diet í”½ì…€ ID
    fbq('track','PageView');          // í˜ì´ì§€ ì§„ì… ì¶”ì 
    </script>
    <noscript>
      <img height="1" width="1" style="display:none"
           src="https://www.facebook.com/tr?id=1494090128389962&ev=PageView&noscript=1" />
    </noscript>
    <!-- End Facebook Pixel Code -->
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">IQãƒ€ã‚¤ã‚¨ãƒƒãƒˆ</h1>
            <p class="subtitle">å°‚é–€çš„ãªãƒ€ã‚¤ã‚¨ãƒƒãƒˆã‚³ãƒ³ã‚µãƒ«ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³</p>
        </header>

        <main>
            <section class="consultation-steps">
                <h2>ç„¡æ–™ã‚³ãƒ³ã‚µãƒ«ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®æµã‚Œ</h2>
                
                <div class="steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>LINEå‹é”è¿½åŠ </h3>
                            <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹é”è¿½åŠ ã—ã¦ãã ã•ã„</p>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>åŸºæœ¬æƒ…å ±ã®å…¥åŠ›</h3>
                            <p>èº«é•·ã€ä½“é‡ã€ç›®æ¨™ä½“é‡ãªã©ã®åŸºæœ¬æƒ…å ±ã‚’ãŠèã‹ã›ãã ã•ã„</p>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æ</h3>
                            <p>é£Ÿç¿’æ…£ã€é‹å‹•ç¿’æ…£ã€ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’è©³ã—ãåˆ†æã—ã¾ã™</p>
                        </div>
                    </div>

                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>å€‹åˆ¥ãƒ—ãƒ©ãƒ³ææ¡ˆ</h3>
                            <p>ã‚ãªãŸã ã‘ã®ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ‰ãƒ€ã‚¤ã‚¨ãƒƒãƒˆãƒ—ãƒ©ãƒ³ã‚’ã”ææ¡ˆ</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="cta-section">
                <h2>ä»Šã™ãç„¡æ–™ã‚³ãƒ³ã‚µãƒ«ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</h2>
                <p>å°‚é–€ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼ãŒã‚ãªãŸã®ç†æƒ³ã®ä½“å‹å®Ÿç¾ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™</p>
                
                <a href="https://lin.ee/m2A7Y15" class="line-button" target="_blank">
                    <img src="https://cdn-icons-png.flaticon.com/512/3670/3670157.png" alt="LINE" class="line-icon">
                    LINEå‹é”è¿½åŠ ã§ç„¡æ–™ç›¸è«‡é–‹å§‹
                </a>

                <div class="benefits">
                    <div class="benefit">
                        <span class="benefit-icon">âœ“</span>
                        <span>å®Œå…¨ç„¡æ–™</span>
                    </div>
                    <div class="benefit">
                        <span class="benefit-icon">âœ“</span>
                        <span>24æ™‚é–“å¯¾å¿œ</span>
                    </div>
                    <div class="benefit">
                        <span class="benefit-icon">âœ“</span>
                        <span>å°‚é–€ã‚«ã‚¦ãƒ³ã‚»ãƒ©ãƒ¼</span>
                    </div>
                </div>
            </section>

            <section class="contact-info">
                <h3>ãŠå•ã„åˆã‚ã›</h3>
                <p>ã”è³ªå•ã‚„ã”ä¸æ˜ãªç‚¹ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã€ãŠæ°—è»½ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
                <p class="contact-line">LINE: <a href="https://lin.ee/m2A7Y15" target="_blank">@iqdiet</a></p>
            </section>
        </main>

        <footer>
            <p>&copy; 2024 IQãƒ€ã‚¤ã‚¨ãƒƒãƒˆ. All rights reserved.</p>
        </footer>
    </div>

    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>LINEã‚¢ãƒ—ãƒªã‚’é–‹ã„ã¦ã„ã¾ã™...</p>
    </div>

    <script>
        // Facebook Pixel Event Tracking
        document.querySelector('.line-button').addEventListener('click', function(e) {
            fbq('track', 'Contact');
            
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            setTimeout(() => {
                loading.style.display = 'none';
            }, 2000);
        });
    </script>
    
<script>
  // ====== ìœ í‹¸ ======
  function genEventId() {
    return 'cid-' + Date.now() + '-' + Math.random().toString(36).slice(2,10);
  }
  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()[]\\\/\+^])/g, '\\$1') + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  function getFbc() {
    // URLì— fbclidê°€ ìˆìœ¼ë©´ _fbc í˜•ì‹ìœ¼ë¡œ ìƒì„±
    const params = new URLSearchParams(location.search);
    const fbclid = params.get('fbclid');
    if (fbclid) return `fb.1.${Date.now()}.${fbclid}`;
    // ì—†ìœ¼ë©´ ì¿ í‚¤ì—ì„œ
    return getCookie('_fbc') || '';
  }

  async function sendLeadToServer(eventId) {
    try {
      console.log('ğŸ“¨ sendLeadToServer() ì‹œì‘, eventId:', eventId);
      
      const email = (document.querySelector('input[name="email"]') || {}).value || '';
      const phone = (document.querySelector('input[name="phone"]') || {}).value || '';

      const payload = {
        eventId,
        eventSourceUrl: location.href,
        email,
        phone,
        fbp: getCookie('_fbp') || '',
        fbc: getFbc(),
        userAgent: navigator.userAgent
      };

      console.log('ğŸ“‹ ì „ì†¡í•  payload:', payload);
      console.log('ğŸŒ /api/lead ìš”ì²­ ì‹œì‘...');

      const response = await fetch('/api/lead', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        keepalive: true // íƒ­ ë‹«í˜€ë„ ì „ì†¡ ì‹œë„
      });

      console.log('ğŸ“¡ ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
      const result = await response.json();
      console.log('ğŸ“„ ì„œë²„ ì‘ë‹µ ë‚´ìš©:', result);
      console.log('ğŸ” ìƒì„¸ Meta ì‘ë‹µ:', result.meta);
      
      if (response.ok) {
        console.log('âœ… CAPI ì „ì†¡ ì„±ê³µ!');
      } else {
        console.log('âŒ CAPI ì „ì†¡ ì‹¤íŒ¨:', result);
      }
    } catch(e) {
      console.error('ğŸš¨ CAPI ì „ì†¡ ì—ëŸ¬:', e);
    }
  }

  // ====== ë¦¬ë“œ ì „ì†¡ í›…(ë²„íŠ¼/í¼ì— ì—°ê²°) ======
  function trackLeadWithDedup() {
    console.log('ğŸš€ trackLeadWithDedup() í˜¸ì¶œë¨');
    const eventId = genEventId();
    console.log('ğŸ“‹ ìƒì„±ëœ eventId:', eventId);
    
    // ë¸Œë¼ìš°ì € í”½ì…€(Lead)
    if (typeof window.fbq === 'function') {
      console.log('âœ… fbq í•¨ìˆ˜ ì¡´ì¬ - ë¸Œë¼ìš°ì € í”½ì…€ ì „ì†¡');
      fbq('track', 'Lead', {}, { eventID: eventId });
    } else {
      console.log('âŒ fbq í•¨ìˆ˜ ì—†ìŒ');
    }
    
    // ì„œë²„(CAPI) ë™ì‹œ ì „ì†¡
    console.log('ğŸŒ ì„œë²„ CAPI ì „ì†¡ ì‹œì‘');
    sendLeadToServer(eventId);
  }

  // 1) ë²„íŠ¼ í´ë¦­ ì‹œ Lead
  const lineBtn = document.querySelector('.line-button');
  if (lineBtn) {
    lineBtn.addEventListener('click', trackLeadWithDedup);
  }

  // 2) í¼ ì œì¶œ ì‹œ Lead (í•„ìš”ì‹œ)
  const leadForm = document.getElementById('leadForm');
  if (leadForm) {
    leadForm.addEventListener('submit', function () {
      trackLeadWithDedup();
    });
  }
</script>
</body>
</html>